#!/bin/bash

# Check currently layered Chrome version against the latest that the CI process found.

function notify_user() {    
    logger $1
    echo $1
    user_name=$(loginctl list-sessions --output=json | jq -r '.[].user')
    uid=$(loginctl list-sessions --output=json | jq -r '.[].uid')
    xdg_runtime_path="/run/user/$uid"
    display_var=$(printenv DISPLAY)
    sudo -u "$user_name" DBUS_SESSION_BUS_ADDRESS=unix:path="$xdg_runtime_path"/bus DISPLAY="$display_var" notify-send "Google Chrome Update Service" "$1" --app-name="Google Chrome Update Service" -u NORMAL
}

function notify_failure() {
    notify_user $1
    exit 1
}

function wait_for_rpm_ostree() {
    RPM_OSTREE_BUSY=$(rpm-ostree status | grep "State: busy")
    while [ -n "$RPM_OSTREE_BUSY" ]; do
        notify_user "Waiting on rpm-ostree"
        sleep 300
        logger "Checking for rpm-ostree to be done"
        RPM_OSTREE_BUSY=$(rpm-ostree status | grep "State: busy")
    done
}

if rpm -q google-chrome-stable > /dev/null; then
    CHROME_INSTALLED_VERSION=$(rpm -q --queryformat '%{VERSION}' google-chrome-stable)
else
    CHROME_INSTALLED_VERSION="not installed" 
fi

CHROME_DOWNLOADED_VERSION=$(cat /usr/share/ublue-tr/chrome-workarounds/google-chrome-current-version)

if [ "$CHROME_INSTALLED_VERSION" == "$CHROME_DOWNLOADED_VERSION" ]; then
    notify_user "Google Chrome ($CHROME_INSTALLED_VERSION) is current"
else
    wait_for_rpm_ostree
    notify_user "Updating Chrome from $CHROME_INSTALLED_VERSION to $CHROME_DOWNLOADED_VERSION"
    if [ "$CHROME_INSTALLED_VERSION" != "not installed" ]; then
        rpm-ostree remove google-chrome-stable || notify_failure "Failed to remove existing Chrome for next reboot"
    fi
    wait_for_rpm_ostree
    rpm-ostree install /usr/share/ublue-tr/chrome-workarounds/google-chrome-stable_current_x86_64.rpm || \
        notify_failure "Failed to install new Chrome version"

    notify_user "Reboot to use new Chrome version $CHROME_DOWNLOADED_VERSION"
fi

if [ -f /etc/yum.repos.d/google-chrome.repo ]; then
    # The RPM installs the Google Chrome yum repo by default.  Apparently rpm-ostree will check this
    # on an ordinary image update, and fail when it does so.
    # To avoid this, we'll disable it.
    sed -i '/enabled/d' /etc/yum.repos.d/google-chrome.repo 
    echo "enabled=0" >> /etc/yum.repos.d/google-chrome.repo
fi
